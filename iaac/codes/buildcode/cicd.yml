AWSTemplateFormatVersion: '2010-09-09'
Description: 'Build docker image for container'

Parameters:
  CodeBucket:
    Type: String
    Default: k1-code-store-20210716

Resources:
  K1Repo:
    Type: AWS::CodeCommit::Repository
    Properties:
      RepositoryName: k1repo
      Code: 
        BranchName: main
        S3: {
          Bucket: 
        }


  K1CodePipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: K1CodePipelineServiceRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: [ codepipeline.amazonaws.com ]
          Action: [ 'sts: AssumeRole' ]
      Path: /
      Policies:
      - PolicyName: K1CodePipelineServicePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow 
            Action:
            # get code from codecommit
            - codecommit:GetBranch
            - codecommit:GetCommit
            - codecommit:UploadArchive
            - codecommit:GetUploadArchiveStatus
            - codecommit:CancelUploadArchive
            Resource: '*'
          - Effect: Allow
            Action:
            - s3:GetObject
            - s3:GetObjectVersion
            - s3:GetBucketVersioning
            Resource: '*'
          - Effect: Allow
            Action:
            - s3:PutObjec
            Resource: '*'
          - Effect: Allow
            Action:
            - elasticloadbalancing:*
            - autoscaling:*
            - cloudwatch:*
            - ecs:*
            - codebuild:*
            - iam:PassRole
            Resource: '*'
  K1CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: K1CodeBuildServiceRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          Effect: Allow
          Principal: 
            Service: [ codebuild.amazonaws.com ]
          Action: [ 'sts: AssumeRole' ]
      Policies:
      - PolicyName: K1CodeBuildServicePolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - 'codecommit:ListBranches'
            - 'codecommit:ListRepositories'
            - 'codecommit:BatchGetRepositories'
            - 'codecommit:Get*'
            - 'codecommit:GitPull'
            Resource:
            - !Sub arn:aws:codecommit:ap-northeast-1:${AWS:AccountId}:${CodeBucket}
          - Effect: Allow
            Action:
            - 'logs:CreateLogGroup'
            - 'logs:CreateLogStream'
            - 'logs:PutLogEvents'
            Resource: '*'
          - Effect: Allow
            Action:
            - 's3:PutObject'
            - 's3:GetObject'
            - 's3:GetObjectVersion'
            - 's3:ListBucket'
            Resource: '*'
          - Effect: Allow
            Action:
            - 'ecr:InitiateLayerUpload'
            - 'ecr:GetAuthorizationToken'
            Resource: '*'

Outputs:
  CodePipelineRole:
    Value: !GetAtt K1CodePipelineServiceRole.Arn
    Export:
      Name: !Join [ ':', [ Ref: AWS::StackName, K1CodePipelineServiceRole ]]

  CodePipelineRole:
    Value: !GetAtt K1CodeBuildServiceRole.Arn
    Export:
      Name: !Join [ ':', [ Ref: AWS::StackName, K1CodeBuildServiceRole ]]
